#!/bin/bash
set -euo pipefail

# Resolve workspace root from this script's location
WS_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")"/.. && pwd)"
cd "$WS_ROOT"

# Source environment once (fast if already built)
if [ -f "$WS_ROOT/install/setup.bash" ]; then
  # Avoid unbound var errors from set -u during sourcing
  set +u
  # shellcheck disable=SC1090
  source "$WS_ROOT/install/setup.bash"
  set -u
fi

# DDS/RMW設定（複数マシン通信を有効に）
export RMW_IMPLEMENTATION=rmw_fastrtps_cpp
# ローカルホスト限定を明示的にOFF（外部と通信できるように）
export ROS_LOCALHOST_ONLY=0
export ROS_LOCALHOST_ONLY=0
# Fast DDSのプロファイルで共有メモリ専用に固定すると外部通信できないため無効化
unset FASTRTPS_DEFAULT_PROFILES_FILE
# QoSはコード/YAMLの設定を使う（XMLの上書きを無効化）
export RMW_FASTRTPS_USE_QOS_FROM_XML=0


bash ./scripts/stop_fv
bash ./scripts/start_fv415.sh
bash ./scripts/start_fv405.sh

# Start Foxglove Bridge (optional)
if ros2 pkg prefix foxglove_bridge >/dev/null 2>&1; then
  echo "🚀 Starting foxglove_bridge..."
  # Note: ros2 launch does not take --ros-args; run without use_sim_time args
  ros2 launch foxglove_bridge foxglove_bridge_launch.xml &
else
  echo "⚠️ foxglove_bridge package not found; skipping"
fi
