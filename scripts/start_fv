#!/bin/bash
set -euo pipefail

# Resolve workspace root from this script's location
WS_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")"/.. && pwd)"
cd "$WS_ROOT"

# Source environment once (fast if already built)
if [ -f "$WS_ROOT/install/setup.bash" ]; then
  # Avoid unbound var errors from set -u during sourcing
  set +u
  # shellcheck disable=SC1090
  source "$WS_ROOT/install/setup.bash"
  set -u
fi

# DDS/RMWè¨­å®šï¼ˆè¤‡æ•°ãƒã‚·ãƒ³é€šä¿¡ã‚’æœ‰åŠ¹ã«ï¼‰
export RMW_IMPLEMENTATION=rmw_fastrtps_cpp
# ãƒ­ãƒ¼ã‚«ãƒ«ãƒ›ã‚¹ãƒˆé™å®šã‚’æ˜ç¤ºçš„ã«OFFï¼ˆå¤–éƒ¨ã¨é€šä¿¡ã§ãã‚‹ã‚ˆã†ã«ï¼‰
export ROS_LOCALHOST_ONLY=0
export ROS_LOCALHOST_ONLY=0
# Fast DDSã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã§å…±æœ‰ãƒ¡ãƒ¢ãƒªå°‚ç”¨ã«å›ºå®šã™ã‚‹ã¨å¤–éƒ¨é€šä¿¡ã§ããªã„ãŸã‚ç„¡åŠ¹åŒ–
unset FASTRTPS_DEFAULT_PROFILES_FILE
# QoSã¯ã‚³ãƒ¼ãƒ‰/YAMLã®è¨­å®šã‚’ä½¿ã†ï¼ˆXMLã®ä¸Šæ›¸ãã‚’ç„¡åŠ¹åŒ–ï¼‰
export RMW_FASTRTPS_USE_QOS_FROM_XML=0


bash ./scripts/stop_fv
bash ./scripts/start_fv415.sh
bash ./scripts/start_fv405.sh

# Start Foxglove Bridge (optional)
if ros2 pkg prefix foxglove_bridge >/dev/null 2>&1; then
  echo "ğŸš€ Starting foxglove_bridge..."
  # Note: ros2 launch does not take --ros-args; run without use_sim_time args
  ros2 launch foxglove_bridge foxglove_bridge_launch.xml &
else
  echo "âš ï¸ foxglove_bridge package not found; skipping"
fi
