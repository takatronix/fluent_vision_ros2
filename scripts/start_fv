#!/bin/bash
set -euo pipefail

# Resolve workspace root from this script's location
WS_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")"/.. && pwd)"
cd "$WS_ROOT"

# Source environment once (fast if already built)
if [ -f "$WS_ROOT/install/setup.bash" ]; then
  # Avoid unbound var errors from set -u during sourcing
  set +u
  # shellcheck disable=SC1090
  source "$WS_ROOT/install/setup.bash"
  set -u
fi

"${WS_ROOT:?}/scripts/stop_fv" || true

# DDS/RMWè¨­å®šï¼ˆè¤‡æ•°ãƒã‚·ãƒ³é€šä¿¡ã‚’æœ‰åŠ¹ã«ï¼‰
export RMW_IMPLEMENTATION=rmw_fastrtps_cpp
# ãƒ­ãƒ¼ã‚«ãƒ«ãƒ›ã‚¹ãƒˆé™å®šã‚’æ˜ç¤ºçš„ã«OFFï¼ˆå¤–éƒ¨ã¨é€šä¿¡ã§ãã‚‹ã‚ˆã†ã«ï¼‰
export ROS_LOCALHOST_ONLY=0
# XMLãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä½¿ã‚ãªã„ï¼ˆå…¨ç’°å¢ƒã§åŒã˜ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæŒ™å‹•ã«åˆã‚ã›ã‚‹ï¼‰
unset FASTRTPS_DEFAULT_PROFILES_FILE
unset FASTDDS_DEFAULT_PROFILES_FILE

# QoSã¯ã‚³ãƒ¼ãƒ‰/YAMLã®è¨­å®šã‚’ä½¿ã†ï¼ˆXMLã§QoSã‚’ä¸Šæ›¸ãã—ãªã„ï¼‰
export RMW_FASTRTPS_USE_QOS_FROM_XML=0


bash ./scripts/start_fv415.sh
bash ./scripts/start_fv405.sh

# Start Foxglove Bridge (optional)
if ros2 pkg prefix foxglove_bridge >/dev/null 2>&1; then
  echo "ğŸš€ Starting foxglove_bridge..."
  # Note: ros2 launch does not take --ros-args; run without use_sim_time args
  ros2 launch foxglove_bridge foxglove_bridge_launch.xml &
else
  echo "âš ï¸ foxglove_bridge package not found; skipping"
fi
