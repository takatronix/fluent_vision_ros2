# アスパラガス矩形内情報表示仕様書

**作成日**: 2025年8月8日 11:45  
**対象ノード**: `fv_aspara_analyzer_node`  
**目的**: アスパラガス矩形内の詳細情報表示仕様

## 概要

アスパラガス検出矩形内に、ID、分析時間、品質情報等を動的に表示する機能の詳細仕様。複数アスパラガス対応のため、各矩形に個別の情報を表示する。

## データ構造

### AsparagusPart構造体
```cpp
struct AsparagusPart {
    int class_id = -1;                         ///< クラスID（0=本体、1=穂）
    cv::Rect bounding_box_2d;                  ///< 2Dバウンディングボックス
    float confidence = 0.0f;                   ///< 検出信頼度
    bool is_valid = false;                     ///< 有効フラグ
};
```

**用途**: アスパラガス本体（class_id=0）と穂（class_id=1）の統一管理

### AsparaInfo構造体内での使用
```cpp
struct AsparaInfo {
    // ...
    AsparagusPart body_part;                   ///< 本体情報（緑色表示）
    std::vector<AsparagusPart> spike_parts;    ///< 穂情報リスト（黄色表示）
    // ...
};
```

## 表示レイアウト

### 1. 選択中アスパラ（フル情報表示）

```
┌─────────────────┐
│ ID: #1 [選択中]   │ ← 基本情報
│ 信頼: 85%        │
│ 距離: 1.2m       │ ← カメラからの距離
│ 点群: 1,234点    │ ← ポイントクラウド点数
│ 分析: 12.3ms     │ ← 分析処理時間（必須表示）
│ ─────────────── │ ← 区切り線
│ 長さ: 28.5cm     │ ← 分析結果
│ 太さ: 15mm       │
│ 真直: 85%        │ ← straightness
│ グレード: A級     │
│ 穂: 2個          │ ← 穂情報（検出時のみ）
└─────────────────┘
```

### 2. 非選択アスパラ（基本情報のみ）

```
┌─────────────┐
│ ID: #2       │
│ 信頼: 72%    │
│ 距離: 1.8m   │
└─────────────┘
```

### 3. 分析状態表示

#### 分析中
```
┌─────────────────┐
│ ID: #1 [選択中]   │
│ 信頼: 85%        │
│ 距離: 1.2m       │
│ 点群: 1,234点    │
│ 分析中...        │ ← 処理中表示
└─────────────────┘
```

#### エラー時
```
┌─────────────────┐
│ ID: #1 [選択中]   │
│ 信頼: 85%        │
│ 距離: 1.2m       │
│ 点群: 0点        │ ← 点群なし
│ 分析: エラー      │ ← エラー表示
└─────────────────┘
```

## 情報優先順位

### レベル1: 基本情報（常時表示）
- **ID**: アスパラガス識別番号
- **信頼度**: 検出信頼度（%）
- **距離**: カメラからの距離（m）

### レベル2: 処理情報（選択中のみ）
- **点群数**: ポイントクラウド点数
- **分析時間**: 処理時間（ms）**※必須表示**

### レベル3: 分析結果（分析完了後）
- **長さ**: アスパラガス長さ（cm）
- **太さ**: 平均直径（mm）
- **真直度**: 直線性（%）
- **グレード**: 品質グレード（A級/B級/C級/規格外）

### レベル4: 穂情報（検出時のみ）
- **穂数**: 検出された穂の数

## 色分けルール

### 矩形・テキスト色
- **グレードA級**: 緑色（RGB: 0, 255, 0）
- **グレードB級**: 黄色（RGB: 255, 255, 0）
- **グレードC級**: オレンジ色（RGB: 255, 128, 0）
- **規格外/エラー**: 赤色（RGB: 255, 0, 0）
- **分析中**: 青色（RGB: 0, 128, 255）
- **未分析**: 緑色（デフォルト）
- **穂矩形**: 常に黄色（RGB: 255, 255, 0）

### 透明度・線の太さ
- **選択中**: 80%透明度背景、2px線
- **非選択**: 40%透明度背景、1px線

## テキスト描画仕様

### フォント設定
- **選択中アスパラ**:
  - フォントサイズ: 0.6
  - 色: 白色（RGB: 255, 255, 255）
  - 影: 黒色、2pxオフセット（視認性向上）
  
- **非選択アスパラ**:
  - フォントサイズ: 0.4
  - 色: グレー（RGB: 128, 128, 128）
  - 影: なし

### レイアウト設定
- **行間隔**: 20px
- **矩形との余白**: 5px
- **テキスト配置**: 矩形上部から順次配置

## 動的表示制御

### 表示判定ロジック
```cpp
// 表示内容の判定
if (aspara.processing_times.total_ms > 0) {
    // 分析完了 → フル情報表示
    displayFullInfo(aspara);
} else if (isAnalysisInProgress(aspara)) {
    // 分析中 → "分析中..."表示
    displayAnalyzing(aspara);
} else if (aspara.pointcloud_count == 0) {
    // 点群なし → エラー表示
    displayError(aspara, "点群なし");
} else {
    // 未分析 → 基本情報のみ
    displayBasicInfo(aspara);
}
```

### 分析結果の表示判定
```cpp
// 分析結果の有効性チェック
if (aspara.length > 0 && aspara.straightness > 0) {
    // 有効な分析結果 → 品質情報表示
    displayQualityInfo(aspara);
}

if (!aspara.spike_parts.empty()) {
    // 穂検出あり → 穂情報表示
    displaySpikeInfo(aspara);
}
```

## 実装上の注意点

### パフォーマンス考慮
- テキスト描画は重い処理のため、変更があった場合のみ更新
- 選択中アスパラのみ詳細情報を表示してリソース節約

### エラーハンドリング
- 分析エラー時は必ず「エラー」表示
- 点群が0の場合は「点群なし」表示
- 分析時間が0の場合は「未分析」扱い

### 国際化対応
- 日本語表示を基本とする
- 将来的な多言語対応を考慮した設計

## 関連ファイル

- **実装ファイル**: `src/fv_aspara_analyzer_node.cpp`
- **ヘッダーファイル**: `include/fv_aspara_analyzer/fv_aspara_analyzer_node.hpp`
- **設定ファイル**: 起動時引数で指定（例: `d415.yaml`, `d405.yaml`）

## 更新履歴

- 2025-08-08 11:45: 初版作成（矩形内情報表示仕様）