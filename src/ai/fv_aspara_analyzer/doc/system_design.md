# fv_aspara_analyzer ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆæ›¸

**ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ**: FluentVision ROS2  
**ãƒãƒ¼ãƒ‰å**: `fv_aspara_analyzer_node`  
**ä½œæˆæ—¥**: 2025å¹´8æœˆ8æ—¥  
**æœ€çµ‚æ›´æ–°**: 2025å¹´8æœˆ8æ—¥ 11:50  

## ç›®æ¬¡

1. [æ¦‚è¦](#æ¦‚è¦)
2. [ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](#ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£)
3. [ãƒ•ãƒ¬ãƒ¼ãƒ æ¯åˆ†æå‡¦ç†](#ãƒ•ãƒ¬ãƒ¼ãƒ æ¯åˆ†æå‡¦ç†)
4. [IDç®¡ç†ã¨ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°](#idç®¡ç†ã¨ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°)
5. [ç©‚ã®å¯†é›†åº¦å¯¾å¿œå‡¦ç†](#ç©‚ã®å¯†é›†åº¦å¯¾å¿œå‡¦ç†)
6. [ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«è¡¨ç¤ºä»•æ§˜](#ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«è¡¨ç¤ºä»•æ§˜)
7. [ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°](#ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°)
8. [è¨­å®šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿](#è¨­å®šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿)
9. [å®Ÿè£…å±¥æ­´](#å®Ÿè£…å±¥æ­´)

---

## æ¦‚è¦

**ç›®çš„**: ã‚¢ã‚¹ãƒ‘ãƒ©ã‚¬ã‚¹æ¤œå‡ºãƒ»è¿½è·¡ãƒ»å“è³ªåˆ†æã®çµ±åˆã‚·ã‚¹ãƒ†ãƒ   
**ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**: 1ã¤ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‹ã‚‰è¤‡æ•°ãƒãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã€èµ·å‹•æ™‚å¼•æ•°ã§è¨­å®šåˆ‡ã‚Šæ›¿ãˆ  
**ç‰¹å¾´**: ãƒ•ãƒ¬ãƒ¼ãƒ æ¯åˆ†æã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å‡¦ç†ã€è¤‡æ•°ã‚¢ã‚¹ãƒ‘ãƒ©IDç®¡ç†ã€ãƒãƒ«ãƒã‚«ãƒ¡ãƒ©å¯¾å¿œ

### ä¸»è¦æ©Ÿèƒ½
- 3Dç‚¹ç¾¤ãƒ™ãƒ¼ã‚¹ã®å“è³ªåˆ†æï¼ˆé•·ã•ãƒ»å¤ªã•ãƒ»çœŸç›´åº¦ï¼‰
- ã‚¢ã‚¹ãƒ‘ãƒ©ã‚¬ã‚¹æœ¬ä½“ã¨ç©‚ã®é–¢é€£ä»˜ã‘
- ã‚¹ãƒ ãƒ¼ã‚ºã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º
- éåŒæœŸå‡¦ç†ã«ã‚ˆã‚‹ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ€§ç¢ºä¿

---

## ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ãƒãƒ¼ãƒ‰æ§‹æˆ
```mermaid
graph TD
    A[fv_aspara_analyzer_d415] --> E[ROS2ã‚·ã‚¹ãƒ†ãƒ ]
    B[fv_aspara_analyzer_d405] --> E
    C[fv_aspara_analyzer_other] --> E
    
    subgraph "D415ã‚«ãƒ¡ãƒ©ç³»"
        A1[YOLOæ¤œå‡ºçµæœ_d415] --> A
        A2[ã‚«ãƒ©ãƒ¼ç”»åƒ_d415] --> A
        A3[æ·±åº¦ç”»åƒ_d415] --> A
        A4[ã‚«ãƒ¡ãƒ©æƒ…å ±_d415] --> A
    end
    
    subgraph "D405ã‚«ãƒ¡ãƒ©ç³»"
        B1[YOLOæ¤œå‡ºçµæœ_d405] --> B
        B2[ã‚«ãƒ©ãƒ¼ç”»åƒ_d405] --> B
        B3[æ·±åº¦ç”»åƒ_d405] --> B
        B4[ã‚«ãƒ¡ãƒ©æƒ…å ±_d405] --> B
    end
```

### èµ·å‹•æ–¹æ³•
```bash
# è¤‡æ•°ãƒãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’åŒæ™‚èµ·å‹•
ros2 run fv_aspara_analyzer fv_aspara_analyzer_node --ros-args --params-file d415.yaml &
ros2 run fv_aspara_analyzer fv_aspara_analyzer_node --ros-args --params-file d405.yaml &
```

### å‡¦ç†ãƒ•ãƒ­ãƒ¼
```mermaid
graph TD
    A[æ¤œå‡ºçµæœå—ä¿¡] --> B[IDç®¡ç†ãƒ»è¿½è·¡]
    B --> C[ç©‚é–¢é€£ä»˜ã‘]
    C --> D[æ¯ãƒ•ãƒ¬ãƒ¼ãƒ åˆ†æ]
    D --> E[å“è³ªè©•ä¾¡]
    E --> F[å¯è¦–åŒ–ãƒ»å‡ºåŠ›]
```

### ãƒ‡ãƒ¼ã‚¿æ§‹é€ 

#### AsparagusPartæ§‹é€ ä½“ï¼ˆéƒ¨ä½æƒ…å ±ï¼‰
```cpp
struct AsparagusPart {
    int class_id = -1;                         ///< ã‚¯ãƒ©ã‚¹IDï¼ˆ0=æœ¬ä½“ã€1=ç©‚ï¼‰
    cv::Rect bounding_box_2d;                  ///< 2Dãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹
    float confidence = 0.0f;                   ///< æ¤œå‡ºä¿¡é ¼åº¦
    bool is_valid = false;                     ///< æœ‰åŠ¹ãƒ•ãƒ©ã‚°
};
```

**ç”¨é€”**: ã‚¢ã‚¹ãƒ‘ãƒ©ã‚¬ã‚¹æœ¬ä½“ã¨ç©‚ã®éƒ¨ä½æƒ…å ±ã‚’çµ±ä¸€ç®¡ç†
- **class_id**: 0=æœ¬ä½“ï¼ˆç·‘è‰²è¡¨ç¤ºï¼‰ã€1=ç©‚ï¼ˆé»„è‰²è¡¨ç¤ºï¼‰
- **confidence**: YOLOæ¤œå‡ºã®ä¿¡é ¼åº¦ã€å¯†é›†åº¦ãƒšãƒŠãƒ«ãƒ†ã‚£é©ç”¨æ¸ˆã¿
- **is_valid**: ç©ºé–“çš„é–¢é€£æ€§ãƒã‚§ãƒƒã‚¯é€šéãƒ•ãƒ©ã‚°

#### SkeletonPointæ§‹é€ ä½“ï¼ˆéª¨æ ¼ãƒã‚¤ãƒ³ãƒˆï¼‰
```cpp
struct SkeletonPoint {
    cv::Point2f image_point;                   ///< 2Dç”»åƒåº§æ¨™
    geometry_msgs::msg::Point world_point;     ///< 3Dä¸–ç•Œåº§æ¨™
    float distance_from_base = 0.0f;           ///< æ ¹å…ƒã‹ã‚‰ã®è·é›¢ï¼ˆãƒ¡ãƒ¼ãƒˆãƒ«ï¼‰
    float radius_at_point = 0.0f;              ///< ãã®ç‚¹ã§ã®åŠå¾„ï¼ˆãƒ¡ãƒ¼ãƒˆãƒ«ï¼‰
};
```

**ç”¨é€”**: ã‚¢ã‚¹ãƒ‘ãƒ©ã‚¬ã‚¹éª¨æ ¼ã®5-10ç‚¹æŠ½å‡ºã€é•·ã•ãƒ»æ›²ãŒã‚Šåº¦ã®è©³ç´°åˆ†æ
- **ãƒ”ãƒ³ã‚¯è‰²è¡¨ç¤º**: éª¨æ ¼ãƒ©ã‚¤ãƒ³ã¨â—¯ãƒãƒ¼ã‚«ãƒ¼
- **3Dåº§æ¨™ä¿å­˜**: ãƒ­ãƒœãƒƒãƒˆåˆ¶å¾¡ãƒ»å“è³ªåˆ†æç”¨
- **è¨­å®šå¯èƒ½ç‚¹æ•°**: 5ç‚¹ã¾ãŸã¯10ç‚¹ï¼ˆè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã§åˆ‡ã‚Šæ›¿ãˆï¼‰

#### AsparaInfoæ§‹é€ ä½“ï¼ˆãƒ¡ã‚¤ãƒ³æƒ…å ±ï¼‰
```cpp
struct AsparaInfo {
    int id;                                    ///< ä¸€æ„è­˜åˆ¥ID
    float confidence;                          ///< æ¤œå‡ºä¿¡é ¼åº¦
    cv::Rect bounding_box_2d;                  ///< ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹
    
    // ç©‚æƒ…å ±çµ±åˆ
    AsparagusPart body_part;                   ///< æœ¬ä½“æƒ…å ±ï¼ˆã‚¯ãƒ©ã‚¹ID 0ï¼‰
    std::vector<AsparagusPart> spike_parts;    ///< ç©‚æƒ…å ±ï¼ˆã‚¯ãƒ©ã‚¹ID 1ï¼‰
    
    // 3Dåˆ†æçµæœ
    sensor_msgs::msg::PointCloud2 filtered_pointcloud;  ///< ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ¸ˆã¿3Dç‚¹ç¾¤
    sensor_msgs::msg::PointCloud2 asparagus_pointcloud; ///< ROIæŠ½å‡ºå¾Œã®ç”Ÿç‚¹ç¾¤ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å‰ï¼‰
    geometry_msgs::msg::Point root_position_3d;         ///< æ ¹å…ƒã®3Dåº§æ¨™
    float length;                              ///< ã‚¢ã‚¹ãƒ‘ãƒ©ã‚¬ã‚¹é•·ã•ï¼ˆãƒ¡ãƒ¼ãƒˆãƒ«ï¼‰
    float straightness;                        ///< çœŸã£ç›´ãåº¦ï¼ˆ0.0-1.0ï¼‰
    bool is_harvestable;                       ///< åç©«å¯èƒ½ãƒ•ãƒ©ã‚°
    AsparaguGrade grade;                       ///< å“è³ªã‚°ãƒ¬ãƒ¼ãƒ‰
    
    // å‡¦ç†æ™‚é–“è¨˜éŒ²
    ProcessingTimes processing_times;          ///< å„å‡¦ç†ã‚¹ãƒ†ãƒƒãƒ—ã®æ™‚é–“
    
    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    cv::Rect smooth_bbox;                      ///< ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°çŸ©å½¢
    float animation_alpha;                     ///< é€æ˜åº¦
    bool is_new;                               ///< æ–°è¦æ¤œå‡ºãƒ•ãƒ©ã‚°
    int frame_count;                           ///< ãƒ•ãƒ¬ãƒ¼ãƒ ã‚«ã‚¦ãƒ³ãƒˆ
    
    // è¿½è·¡ç”¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰  
    int detection_count;                       ///< æ¤œå‡ºå›æ•°
    float overlap_ratio;                       ///< å‰ãƒ•ãƒ¬ãƒ¼ãƒ ã¨ã®é‡è¤‡åº¦
    rclcpp::Time first_detected_time;          ///< åˆå›æ¤œå‡ºæ™‚åˆ»
    rclcpp::Time last_update_time;             ///< æœ€å¾Œã®æ›´æ–°æ™‚åˆ»
};
```

#### SelectedAsparaInfoæ§‹é€ ä½“ï¼ˆé¸æŠä¸­ã‚¢ã‚¹ãƒ‘ãƒ©è©³ç´°æƒ…å ±ï¼‰
```cpp
struct SelectedAsparaInfo {
    int asparagus_id = -1;                     ///< é¸æŠä¸­IDï¼ˆ-1=æœªé¸æŠï¼‰
    bool is_selected = false;                  ///< é¸æŠçŠ¶æ…‹
    
    // 2Dæ¤œå‡ºæƒ…å ±ï¼ˆæœ¬ä½“ãƒ»ç©‚ï¼‰
    AsparagusPart body_part;                   ///< æœ¬ä½“æƒ…å ±ï¼ˆã‚¯ãƒ©ã‚¹ID 0ï¼‰
    std::vector<AsparagusPart> spike_parts;    ///< ç©‚æƒ…å ±ãƒªã‚¹ãƒˆï¼ˆã‚¯ãƒ©ã‚¹ID 1ï¼‰
    
    // å“è³ªæƒ…å ±ï¼ˆå…¨ã¦ãƒ¡ãƒ¼ãƒˆãƒ«å˜ä½ï¼‰
    float length = 0.0f;                       ///< é•·ã•ï¼ˆãƒ¡ãƒ¼ãƒˆãƒ«ï¼‰
    float distance_from_camera = 0.0f;         ///< ã‚«ãƒ¡ãƒ©ã‹ã‚‰ã®è·é›¢ï¼ˆãƒ¡ãƒ¼ãƒˆãƒ«ï¼‰
    float curvature = 0.0f;                    ///< æ›²ãŒã‚Šåº¦ï¼ˆãƒ¡ãƒ¼ãƒˆãƒ«ï¼‰
    float diameter = 0.0f;                     ///< å¤ªã•ï¼ˆãƒ¡ãƒ¼ãƒˆãƒ«ï¼‰
    AsparaguGrade grade = AsparaguGrade::UNKNOWN; ///< å“è³ªã‚°ãƒ¬ãƒ¼ãƒ‰
    
    // åˆ‡æ–­æƒ…å ±
    bool is_cutting_target = false;            ///< åˆ‡æ–­å¯¾è±¡ãƒ•ãƒ©ã‚°
    cv::Point2f cut_point_pixel;               ///< åˆ‡æ–­ãƒã‚¤ãƒ³ãƒˆç”»åƒåº§æ¨™ï¼ˆãƒ”ã‚¯ã‚»ãƒ«ï¼‰
    geometry_msgs::msg::Point cut_point_world; ///< åˆ‡æ–­ãƒã‚¤ãƒ³ãƒˆ3Dåº§æ¨™ï¼ˆãƒ¡ãƒ¼ãƒˆãƒ«ï¼‰
    
    // éª¨æ ¼ãƒã‚¤ãƒ³ãƒˆé…åˆ—ï¼ˆè¨­è¨ˆæ›¸é€šã‚Š5-10ç‚¹ï¼‰
    std::vector<SkeletonPoint> skeleton_points; ///< éª¨æ ¼ãƒã‚¤ãƒ³ãƒˆé…åˆ—ï¼ˆé ‚ç‚¹ã‹ã‚‰æ ¹å…ƒã¾ã§ï¼‰
    
    // ãƒ¡ã‚¿æƒ…å ±
    float confidence = 0.0f;                   ///< ä¿¡é ¼åº¦ï¼ˆ0.0-1.0ï¼‰
    rclcpp::Time timestamp;                    ///< ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
};
```

**ç”¨é€”**: é¸æŠä¸­ã‚¢ã‚¹ãƒ‘ãƒ©ã‚¬ã‚¹ã®è©³ç´°åˆ†æçµæœã¨ãƒ­ãƒœãƒƒãƒˆåˆ¶å¾¡æƒ…å ±
- **åˆ‡æ–­ãƒã‚¤ãƒ³ãƒˆ**: 2Dç”»åƒåº§æ¨™ã¨3Dä¸–ç•Œåº§æ¨™ã®ä¸¡æ–¹ã‚’ä¿æŒ
- **éª¨æ ¼ãƒã‚¤ãƒ³ãƒˆ**: 5-10ç‚¹ã®è©³ç´°éª¨æ ¼æƒ…å ±ï¼ˆãƒ”ãƒ³ã‚¯è‰²è¡¨ç¤ºï¼‰
- **å“è³ªè©•ä¾¡**: é•·ã•ãƒ»å¤ªã•ãƒ»æ›²ãŒã‚Šåº¦ãƒ»ã‚°ãƒ¬ãƒ¼ãƒ‰åˆ¤å®š

---

## ç‚¹ç¾¤å‡¦ç†ã®è©³ç´°

### ç‚¹ç¾¤ãƒ‡ãƒ¼ã‚¿ã®æµã‚Œ

1. **ROIæŠ½å‡ºï¼ˆfiltered_cloudï¼‰**
   - æ·±åº¦ç”»åƒã‹ã‚‰ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹å†…ã®ç‚¹ç¾¤ã‚’æŠ½å‡º
   - ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å‰ã®ç”Ÿãƒ‡ãƒ¼ã‚¿
   - `asparagus_pointcloud`ã¨ã—ã¦å…¬é–‹ï¼ˆé¸æŠä¸­ã®ã‚¢ã‚¹ãƒ‘ãƒ©ã®ã¿ï¼‰

2. **ãƒã‚¤ã‚ºé™¤å»ï¼ˆdenoised_cloudï¼‰**
   - ãƒœã‚¯ã‚»ãƒ«ã‚°ãƒªãƒƒãƒ‰ãƒ•ã‚£ãƒ«ã‚¿ã§ãƒ€ã‚¦ãƒ³ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°
   - çµ±è¨ˆçš„å¤–ã‚Œå€¤é™¤å»ãƒ•ã‚£ãƒ«ã‚¿ã§ãƒã‚¤ã‚ºé™¤å»
   - `filtered_pointcloud`ã¨ã—ã¦å…¬é–‹

### å…¬é–‹ãƒˆãƒ”ãƒƒã‚¯

- **`/fv/d415/aspara_analysis/filtered_points`**: ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ¸ˆã¿ç‚¹ç¾¤ï¼ˆå…¨ã‚¢ã‚¹ãƒ‘ãƒ©ï¼‰
- **`/fv/d415/aspara_analysis/selected_points`**: é¸æŠä¸­ã‚¢ã‚¹ãƒ‘ãƒ©ã®ç”Ÿç‚¹ç¾¤ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å‰ï¼‰

### AsparaInfoæ§‹é€ ä½“ã®ç‚¹ç¾¤ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

```cpp
// 3Dåˆ†æçµæœ
sensor_msgs::msg::PointCloud2 filtered_pointcloud;  ///< ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ¸ˆã¿3Dç‚¹ç¾¤
sensor_msgs::msg::PointCloud2 asparagus_pointcloud; ///< ROIæŠ½å‡ºå¾Œã®ç”Ÿç‚¹ç¾¤ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å‰ï¼‰
```

**é‡è¦ãªé•ã„**:
- `asparagus_pointcloud`: ROIæŠ½å‡ºç›´å¾Œã®ç”Ÿãƒ‡ãƒ¼ã‚¿ã€ãƒã‚¤ã‚ºã‚’å«ã‚€é«˜å¯†åº¦ç‚¹ç¾¤
- `filtered_pointcloud`: ãƒã‚¤ã‚ºé™¤å»ãƒ»ãƒ€ã‚¦ãƒ³ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°æ¸ˆã¿ã€åˆ†æç”¨ã®æ¸…æµ„ãªç‚¹ç¾¤

---

## ãƒ•ãƒ¬ãƒ¼ãƒ æ¯åˆ†æå‡¦ç†

### é‡è¦ãªè¨­è¨ˆæ–¹é‡å¤‰æ›´

**å•é¡Œ**: åŒã˜æŒ‡æ‘˜ã‚’ç¹°ã‚Šè¿”ã—å—ã‘ã‚‹ã“ã¨ã‚’é˜²ããŸã‚ã€å‡¦ç†ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’æ˜ç¢ºåŒ–

#### å‡¦ç†ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®åˆ†é›¢
- **æ¤œå‡ºå‡¦ç†**: ä½FPSï¼ˆ5-10fpsï¼‰- YOLOãªã©ã®é‡ã„å‡¦ç†
- **åˆ†æå‡¦ç†**: é«˜FPSï¼ˆ30fpsï¼‰- æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã£ãŸæ¯ãƒ•ãƒ¬ãƒ¼ãƒ å‡¦ç†

### å®Ÿè£…ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

#### detectionCallbackï¼ˆæ¤œå‡ºæƒ…å ±æ›´æ–°ã®ã¿ï¼‰
```cpp
void FvAsparaAnalyzerNode::detectionCallback(...) {
    // ã‚¢ã‚¹ãƒ‘ãƒ©ã‚¬ã‚¹æƒ…å ±ã®æ›´æ–°ã®ã¿
    updateAsparagusList(...);
    
    // æ¤œå‡ºæƒ…å ±æ›´æ–°æ™‚ã¯ç‚¹ç¾¤å‡¦ç†ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆimageCallbackã§æ¯ãƒ•ãƒ¬ãƒ¼ãƒ å®Ÿè¡Œï¼‰
    // processAsparagus(selected_aspara_info_); â† ã“ã®å‡¦ç†ã¯å‰Šé™¤æ¸ˆã¿
}
```

#### imageCallbackï¼ˆæ¯ãƒ•ãƒ¬ãƒ¼ãƒ åˆ†æå‡¦ç†ï¼‰
```cpp
void FvAsparaAnalyzerNode::imageCallback(...) {
    // æ—¢å­˜ã®ç”»åƒå‡¦ç†...
    
    // é¸æŠä¸­ã®ã‚¢ã‚¹ãƒ‘ãƒ©ã®ç‚¹ç¾¤å‡¦ç†ã‚’æ¯ãƒ•ãƒ¬ãƒ¼ãƒ å®Ÿè¡Œ
    if (selected_aspara_id_ != -1 && enable_pointcloud_processing_ && !aspara_list_.empty()) {
        for (auto& aspara : aspara_list_) {
            if (aspara.id == selected_aspara_id_) {
                try {
                    // åˆ†ææ™‚é–“è¨ˆæ¸¬é–‹å§‹
                    auto start_time = std::chrono::high_resolution_clock::now();
                    
                    processAsparagus(aspara);
                    
                    // åˆ†ææ™‚é–“è¨ˆæ¸¬çµ‚äº†ãƒ»è¨˜éŒ²
                    auto end_time = std::chrono::high_resolution_clock::now();
                    auto duration = std::chrono::duration_cast<std::chrono::milliseconds>(end_time - start_time);
                    aspara.processing_times.total_ms = duration.count();
                    
                } catch (const std::exception& e) {
                    RCLCPP_ERROR(this->get_logger(), "Exception in asparagus analysis: %s", e.what());
                    aspara.processing_times.total_ms = 0.0;
                }
                break;
            }
        }
    }
}
```

### å¿…é ˆè¦ä»¶
1. **åˆ†ææ™‚é–“è¡¨ç¤º**: é¸æŠä¸­ã‚¢ã‚¹ãƒ‘ãƒ©ã®å‡¦ç†æ™‚é–“ã‚’å¿…ãšç”»é¢è¡¨ç¤º
2. **è¨­å®šãƒ•ãƒ©ã‚°**: `enable_pointcloud_processing_`ã§å‡¦ç†åˆ¶å¾¡
3. **æ¯ãƒ•ãƒ¬ãƒ¼ãƒ å‡¦ç†**: imageCallbackã§æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã£ã¦é«˜FPSåˆ†æ
4. **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ€§**: æ¤œå‡ºã¯é…ãã¦ã‚‚åˆ†æã¯ã‚¹ãƒ ãƒ¼ã‚ºã«è¡¨ç¤º

---

## IDç®¡ç†ã¨ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°

### AsparaSelectionçµ±åˆ
- **IoUé–¾å€¤**: 70%ã§åŒä¸€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆåˆ¤å®š
- **ã‚¹ãƒ ãƒ¼ã‚ºã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³**: fluent_libä½¿ç”¨
- **æœ€é©å€™è£œé¸å®š**: è·é›¢å„ªå…ˆï¼ˆçŸ©å½¢ã‚µã‚¤ã‚ºï¼‰ã€ä¿¡é ¼åº¦æ¬¡ç‚¹

### è¿½è·¡ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 
```cpp
std::vector<AsparaInfo> updateAsparaList(
    const std::vector<std::pair<cv::Rect, float>>& new_detections,
    const std::vector<AsparaInfo>& existing_aspara_list) {
    
    // 1. æ–°æ¤œå‡ºã¨æ—¢å­˜ã‚¢ã‚¹ãƒ‘ãƒ©ã®ãƒãƒƒãƒãƒ³ã‚°ï¼ˆIoU 70%ï¼‰
    // 2. ãƒãƒƒãƒã—ãŸå ´åˆï¼šã‚¹ãƒ ãƒ¼ã‚ºã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ›´æ–°
    // 3. æ–°è¦ã®å ´åˆï¼šæ–°ã—ã„IDå‰²ã‚Šå½“ã¦
    // 4. æ¶ˆå¤±ã—ãŸå ´åˆï¼šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç®¡ç†
}
```

---

## ç©‚ã®å¯†é›†åº¦å¯¾å¿œå‡¦ç†

### å•é¡Œ
è¤‡æ•°ã®ã‚¢ã‚¹ãƒ‘ãƒ©ã‚¬ã‚¹çŸ©å½¢ãŒé‡ãªã£ã¦ã„ã‚‹å ´åˆã€ç©‚ã®æ‰€å±åˆ¤å®šãŒå›°é›£

### è§£æ±ºæ–¹æ³•
```cpp
// ç©‚ãŒã©ã®çŸ©å½¢ã«å«ã¾ã‚Œã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆè¤‡æ•°ã®å ´åˆã¯å¯†é›†åº¦ã‚’è€ƒæ…®ï¼‰
std::vector<int> overlapping_aspara_indices;

// å…¨ã‚¢ã‚¹ãƒ‘ãƒ©ã‚¬ã‚¹ã¨ã®é‡è¤‡ã‚’ãƒã‚§ãƒƒã‚¯
for (size_t i = 0; i < aspara_list_.size(); ++i) {
    float overlap = aspara_selection_.calculateOverlap(bbox, aspara_list_[i].bounding_box_2d);
    if (overlap > 0.3f) {  // 30%ä»¥ä¸Šé‡è¤‡
        overlapping_aspara_indices.push_back(i);
    }
}

// å¯†é›†åº¦ã«ã‚ˆã‚‹ä¿¡é ¼åº¦èª¿æ•´
if (overlapping_aspara_indices.size() > 1) {
    // è¤‡æ•°ã®ã‚¢ã‚¹ãƒ‘ãƒ©ã¨é‡è¤‡ã—ã¦ã„ã‚‹å ´åˆã¯ã€Œãã®ã‚¢ã‚¹ãƒ‘ãƒ©ã®é ­éƒ¨ã¨ã—ã¦åˆ¤æ–­ã™ã‚‹ä¿¡é ¼åº¦ã€ã‚’ä¸‹ã’ã‚‹
    float density_penalty = 1.0f / overlapping_aspara_indices.size();
    spike_part.confidence = confidence * density_penalty;
}
```

**é‡è¦**: ã“ã®ä¿¡é ¼åº¦èª¿æ•´ã¯ã€Œç©‚ã®æ¤œå‡ºä¿¡é ¼åº¦ã€ã§ã¯ãªãã€ã€Œãã®ã‚¢ã‚¹ãƒ‘ãƒ©ã®é ­éƒ¨ã¨ã—ã¦åˆ¤æ–­ã™ã‚‹ä¿¡é ¼åº¦ã€ã‚’ä¸‹ã’ã¦ã„ã‚‹ã€‚å¯†é›†ã—ãŸå ´æ‰€ã§ã¯ã€ã©ã®ã‚¢ã‚¹ãƒ‘ãƒ©ã®é ­ãªã®ã‹åˆ¤æ–­ãŒæ›–æ˜§ã«ãªã‚‹ãŸã‚ã€‚

---

## ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«è¡¨ç¤ºä»•æ§˜

### åŸºæœ¬è¡¨ç¤ºãƒ«ãƒ¼ãƒ«
- **ã‚¢ã‚¹ãƒ‘ãƒ©ã‚¬ã‚¹æœ¬ä½“**: ç·‘è‰²
- **ç©‚**: é»„è‰²
- **é¸æŠä¸­**: 80%é€æ˜åº¦èƒŒæ™¯ã€2pxãƒ©ã‚¤ãƒ³
- **éé¸æŠ**: 40%é€æ˜åº¦èƒŒæ™¯ã€1pxãƒ©ã‚¤ãƒ³

### çŸ©å½¢å†…æƒ…å ±è¡¨ç¤º

#### é¸æŠä¸­ã‚¢ã‚¹ãƒ‘ãƒ©ï¼ˆãƒ•ãƒ«æƒ…å ±ï¼‰
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ID: #1 [é¸æŠä¸­]   â”‚ â† åŸºæœ¬æƒ…å ±
â”‚ ä¿¡é ¼: 85%        â”‚
â”‚ è·é›¢: 1.2m       â”‚ â† ã‚«ãƒ¡ãƒ©ã‹ã‚‰ã®è·é›¢
â”‚ ç‚¹ç¾¤: 1,234ç‚¹    â”‚ â† ãƒã‚¤ãƒ³ãƒˆã‚¯ãƒ©ã‚¦ãƒ‰ç‚¹æ•°
â”‚ åˆ†æ: 12.3ms     â”‚ â† åˆ†æå‡¦ç†æ™‚é–“ï¼ˆå¿…é ˆï¼‰
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ é•·ã•: 28.5cm     â”‚ â† åˆ†æçµæœ
â”‚ å¤ªã•: 15mm       â”‚
â”‚ çœŸç›´: 85%        â”‚
â”‚ ã‚°ãƒ¬ãƒ¼ãƒ‰: Aç´š     â”‚
â”‚ ç©‚: 2å€‹          â”‚ â† ç©‚æƒ…å ±
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### éé¸æŠã‚¢ã‚¹ãƒ‘ãƒ©ï¼ˆåŸºæœ¬æƒ…å ±ã®ã¿ï¼‰
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ID: #2       â”‚
â”‚ ä¿¡é ¼: 72%    â”‚
â”‚ è·é›¢: 1.8m   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ã‚°ãƒ¬ãƒ¼ãƒ‰åˆ¥è‰²åˆ†ã‘
- **Aç´š**: ç·‘è‰²çŸ©å½¢ãƒ»ãƒ†ã‚­ã‚¹ãƒˆ
- **Bç´š**: é»„è‰²çŸ©å½¢ãƒ»ãƒ†ã‚­ã‚¹ãƒˆ  
- **Cç´š**: ã‚ªãƒ¬ãƒ³ã‚¸çŸ©å½¢ãƒ»ãƒ†ã‚­ã‚¹ãƒˆ
- **è¦æ ¼å¤–/ã‚¨ãƒ©ãƒ¼**: èµ¤è‰²çŸ©å½¢ãƒ»ãƒ†ã‚­ã‚¹ãƒˆ
- **åˆ†æä¸­**: é’è‰²çŸ©å½¢ãƒ»ãƒ†ã‚­ã‚¹ãƒˆ

### å‹•çš„è¡¨ç¤ºåˆ¶å¾¡
```cpp
if (aspara.processing_times.total_ms > 0) {
    // åˆ†æå®Œäº† â†’ ãƒ•ãƒ«æƒ…å ±è¡¨ç¤º
} else if (analysis_in_progress) {
    // åˆ†æä¸­ â†’ "åˆ†æä¸­..."è¡¨ç¤º
} else {
    // æœªåˆ†æ â†’ åŸºæœ¬æƒ…å ±ã®ã¿
}
```

---

## ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### åˆ†æå‡¦ç†ã‚¨ãƒ©ãƒ¼å¯¾ç­–
- try-catchã§ã‚¨ãƒ©ãƒ¼ã‚’ã‚­ãƒ£ãƒƒãƒ
- ã‚·ã‚¹ãƒ†ãƒ ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã‚’é˜²æ­¢
- ã‚¨ãƒ©ãƒ¼æ™‚ã¯åˆ†ææ™‚é–“ã‚’0ã«è¨­å®š
- å‡¦ç†ç¶™ç¶šã‚’ä¿è¨¼

### ãƒ­ã‚°å‡ºåŠ›
```cpp
try {
    RCLCPP_DEBUG(this->get_logger(), "Starting analysis for asparagus ID %d", aspara.id);
    processAsparagus(aspara);
    RCLCPP_DEBUG(this->get_logger(), "Analysis completed: %.1fms", processing_time);
} catch (const std::exception& e) {
    RCLCPP_ERROR(this->get_logger(), "Exception in analysis: %s", e.what());
} catch (...) {
    RCLCPP_ERROR(this->get_logger(), "Unknown exception in analysis");
}
```

---

## è¨­å®šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿

### é‡è¦ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
```yaml
# ãƒã‚¤ãƒ³ãƒˆã‚¯ãƒ©ã‚¦ãƒ‰å‡¦ç†åˆ¶å¾¡
enable_pointcloud_processing: true     # æœ‰åŠ¹/ç„¡åŠ¹åˆ‡ã‚Šæ›¿ãˆ

# IDç®¡ç†ãƒ»è¿½è·¡
object_tracking_overlap_threshold: 0.7  # IoUé–¾å€¤ï¼ˆ70%ï¼‰
object_tracking_timeout_ms: 5000       # è¿½è·¡ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ

# è¡¨ç¤ºè¨­å®š
selected_asparagus_opacity: 0.8        # é¸æŠä¸­é€æ˜åº¦
selected_asparagus_thickness: 2        # é¸æŠä¸­ç·šã®å¤ªã•
unselected_asparagus_opacity: 0.4      # éé¸æŠé€æ˜åº¦
unselected_asparagus_thickness: 1      # éé¸æŠç·šã®å¤ªã•

# ç©‚é–¢é€£ä»˜ã‘
spike_overlap_threshold: 0.3           # ç©‚ã®é‡è¤‡åˆ¤å®šï¼ˆ30%ï¼‰
```

---

## å®Ÿè£…å±¥æ­´

### 2025-08-08 å®Ÿè£…å®Œäº†é …ç›®
1. **11:33**: ç©‚å¯†é›†åº¦å¯¾å¿œã¨IDç®¡ç†çµ±åˆå®Ÿè£…å®Œäº†
2. **11:40**: ãƒ•ãƒ¬ãƒ¼ãƒ æ¯åˆ†æå‡¦ç†æ–¹é‡ã‚’ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåŒ–  
3. **11:45**: åˆ†æå‡¦ç†ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°è¿½åŠ 
4. **11:50**: çŸ©å½¢å†…æƒ…å ±è¡¨ç¤ºä»•æ§˜ã‚’è¨­è¨ˆæ›¸ã«çµ±åˆ

### ç¾åœ¨ã®å®Ÿè£…çŠ¶æ³
- âœ… ãƒ•ãƒ¬ãƒ¼ãƒ æ¯åˆ†æå‡¦ç†ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
- âœ… IDç®¡ç†ã¨ã‚¹ãƒ ãƒ¼ã‚ºã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
- âœ… ç©‚ã®å¯†é›†åº¦å¯¾å¿œå‡¦ç†
- âœ… ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨ãƒ­ã‚°
- ğŸ”„ çŸ©å½¢å†…è©³ç´°æƒ…å ±è¡¨ç¤ºï¼ˆå®Ÿè£…ä¸­ï¼‰

### æ¬¡ã®å®Ÿè£…äºˆå®š
1. çŸ©å½¢å†…è©³ç´°æƒ…å ±è¡¨ç¤ºå®Ÿè£…
2. ã‚°ãƒ¬ãƒ¼ãƒ‰åˆ¥è‰²åˆ†ã‘å®Ÿè£…
3. ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ãƒ†ã‚¹ãƒˆ

---

## é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

### ã‚³ã‚¢å®Ÿè£…
- `src/fv_aspara_analyzer_node.cpp`: ãƒ¡ã‚¤ãƒ³å®Ÿè£…
- `include/fv_aspara_analyzer/fv_aspara_analyzer_node.hpp`: ãƒ˜ãƒƒãƒ€ãƒ¼
- `src/aspara_selection.cpp`: IDç®¡ç†ãƒ»é¸æŠæ©Ÿèƒ½
- `include/fv_aspara_analyzer/aspara_selection.hpp`: é¸æŠç®¡ç†ãƒ˜ãƒƒãƒ€ãƒ¼

### è¨­å®šãƒ»èµ·å‹•
- `launch/fv_aspara_analyzer_d415.yaml`: D415ã‚«ãƒ¡ãƒ©ç”¨è¨­å®šï¼ˆå¼•æ•°ã¨ã—ã¦æ¸¡ã•ã‚Œã‚‹ï¼‰
- `launch/fv_aspara_analyzer_d405.yaml`: D405ã‚«ãƒ¡ãƒ©ç”¨è¨­å®šï¼ˆå¼•æ•°ã¨ã—ã¦æ¸¡ã•ã‚Œã‚‹ï¼‰
- `launch/high_fps_aspara_analyzer_d405.yaml`: é«˜FPSè¨­å®š
- `launch/start_fv.sh`: èµ·å‹•ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆè¤‡æ•°ã‚«ãƒ¡ãƒ©å¯¾å¿œï¼‰

### ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- `doc/system_design.md`: æœ¬è¨­è¨ˆæ›¸
- `doc/display_specification.md`: è¡¨ç¤ºä»•æ§˜è©³ç´°æ›¸